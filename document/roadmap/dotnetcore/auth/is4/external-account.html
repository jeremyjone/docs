<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>外部身份验证 | JeremyJone 的文档站</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="jeremyjone document web">
    <link rel="preload" href="/docs/assets/css/0.styles.6e50260c.css" as="style"><link rel="preload" href="/docs/assets/js/app.f8f5e4c5.js" as="script"><link rel="preload" href="/docs/assets/js/2.19a43536.js" as="script"><link rel="preload" href="/docs/assets/js/34.8585a287.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.3691e76b.js"><link rel="prefetch" href="/docs/assets/js/11.f8b1d233.js"><link rel="prefetch" href="/docs/assets/js/12.bcded276.js"><link rel="prefetch" href="/docs/assets/js/13.81fa9350.js"><link rel="prefetch" href="/docs/assets/js/14.f8eb5d82.js"><link rel="prefetch" href="/docs/assets/js/15.8b06c3b9.js"><link rel="prefetch" href="/docs/assets/js/16.4ccc1e29.js"><link rel="prefetch" href="/docs/assets/js/17.50c5b049.js"><link rel="prefetch" href="/docs/assets/js/18.10e454f4.js"><link rel="prefetch" href="/docs/assets/js/19.f8c17172.js"><link rel="prefetch" href="/docs/assets/js/20.50c62eb9.js"><link rel="prefetch" href="/docs/assets/js/21.1036bc19.js"><link rel="prefetch" href="/docs/assets/js/22.5cf68d20.js"><link rel="prefetch" href="/docs/assets/js/23.f0abdea8.js"><link rel="prefetch" href="/docs/assets/js/24.54564913.js"><link rel="prefetch" href="/docs/assets/js/25.20b80626.js"><link rel="prefetch" href="/docs/assets/js/26.55fb8b27.js"><link rel="prefetch" href="/docs/assets/js/27.844f4681.js"><link rel="prefetch" href="/docs/assets/js/28.0bad18f1.js"><link rel="prefetch" href="/docs/assets/js/29.f195ced1.js"><link rel="prefetch" href="/docs/assets/js/3.01742876.js"><link rel="prefetch" href="/docs/assets/js/30.ea96f2b2.js"><link rel="prefetch" href="/docs/assets/js/31.3d8b29ad.js"><link rel="prefetch" href="/docs/assets/js/32.358722dc.js"><link rel="prefetch" href="/docs/assets/js/33.7c07692a.js"><link rel="prefetch" href="/docs/assets/js/35.bb57dc93.js"><link rel="prefetch" href="/docs/assets/js/36.7f6ee621.js"><link rel="prefetch" href="/docs/assets/js/37.55bff23d.js"><link rel="prefetch" href="/docs/assets/js/38.14924d26.js"><link rel="prefetch" href="/docs/assets/js/39.521fc873.js"><link rel="prefetch" href="/docs/assets/js/4.14d5ca3e.js"><link rel="prefetch" href="/docs/assets/js/40.66f7f3b6.js"><link rel="prefetch" href="/docs/assets/js/41.ab0fc7b5.js"><link rel="prefetch" href="/docs/assets/js/42.f50f51e1.js"><link rel="prefetch" href="/docs/assets/js/43.89c895d8.js"><link rel="prefetch" href="/docs/assets/js/44.9d883802.js"><link rel="prefetch" href="/docs/assets/js/45.3d73cde6.js"><link rel="prefetch" href="/docs/assets/js/46.e640d621.js"><link rel="prefetch" href="/docs/assets/js/47.d96ce7e7.js"><link rel="prefetch" href="/docs/assets/js/48.c7adf125.js"><link rel="prefetch" href="/docs/assets/js/49.a5b12ab9.js"><link rel="prefetch" href="/docs/assets/js/5.a5e1ba03.js"><link rel="prefetch" href="/docs/assets/js/50.d5ee288d.js"><link rel="prefetch" href="/docs/assets/js/51.09b7c898.js"><link rel="prefetch" href="/docs/assets/js/52.20275ac2.js"><link rel="prefetch" href="/docs/assets/js/53.ac1a6ed6.js"><link rel="prefetch" href="/docs/assets/js/54.b6235842.js"><link rel="prefetch" href="/docs/assets/js/55.c2c1c35a.js"><link rel="prefetch" href="/docs/assets/js/56.ef98af08.js"><link rel="prefetch" href="/docs/assets/js/57.3dce647c.js"><link rel="prefetch" href="/docs/assets/js/58.66d90b68.js"><link rel="prefetch" href="/docs/assets/js/59.d5bde72c.js"><link rel="prefetch" href="/docs/assets/js/6.5b4c40c7.js"><link rel="prefetch" href="/docs/assets/js/60.14472361.js"><link rel="prefetch" href="/docs/assets/js/61.20e07ec3.js"><link rel="prefetch" href="/docs/assets/js/62.c3330802.js"><link rel="prefetch" href="/docs/assets/js/63.d1ec2431.js"><link rel="prefetch" href="/docs/assets/js/7.360cd8bb.js"><link rel="prefetch" href="/docs/assets/js/8.7df23b94.js"><link rel="prefetch" href="/docs/assets/js/9.18120e12.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.6e50260c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/assets/img/logo.png" alt="JeremyJone 的文档站" class="logo"> <span class="site-name can-hide">JeremyJone 的文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码相关菜单" class="dropdown-title"><span class="title">代码相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/standard/" class="nav-link">
  代码编写规范
</a></li><li class="dropdown-item"><!----> <a href="/docs/codes/" class="nav-link">
  代码库
</a></li></ul></div></div><div class="nav-item"><a href="/docs/document/" class="nav-link router-link-active">
  文档手册
</a></div><div class="nav-item"><a href="https://jeremyjone.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/jeremyjone/docs-admin" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码相关菜单" class="dropdown-title"><span class="title">代码相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/standard/" class="nav-link">
  代码编写规范
</a></li><li class="dropdown-item"><!----> <a href="/docs/codes/" class="nav-link">
  代码库
</a></li></ul></div></div><div class="nav-item"><a href="/docs/document/" class="nav-link router-link-active">
  文档手册
</a></div><div class="nav-item"><a href="https://jeremyjone.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/jeremyjone/docs-admin" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git 使用文档</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Markdown 使用文档</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vim 使用文档</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>持续学习路线</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/document/roadmap/" aria-current="page" class="sidebar-link">学习路线</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>.NET 学习之路</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/document/roadmap/dotnetcore/" aria-current="page" class="sidebar-link">ASP.NET Core 开发者学习路线图</a></li><li><a href="/docs/document/roadmap/dotnetcore/basic.html" class="sidebar-link">基础知识</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>依赖注入</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>对象映射</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>认证与授权</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/document/roadmap/dotnetcore/auth/" aria-current="page" class="sidebar-link">概述</a></li><li><a href="/docs/document/roadmap/dotnetcore/auth/example.html" class="sidebar-link">在 ASP.NET 中使用授权与认证</a></li><li><a href="/docs/document/roadmap/dotnetcore/auth/jwt.html" class="sidebar-link">JWT</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><p class="sidebar-heading open"><span>IdentityServer4</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/document/roadmap/dotnetcore/auth/is4/" aria-current="page" class="sidebar-link">IdentityServer4 的使用</a></li><li><a href="/docs/document/roadmap/dotnetcore/auth/is4/useef.html" class="sidebar-link">数据的持久化（使用数据库）</a></li><li><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html" aria-current="page" class="active sidebar-link">外部身份验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#添加一个预定义的身份验证" class="sidebar-link">添加一个预定义的身份验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#配置一个-microsoft-身份验证" class="sidebar-link">配置一个 Microsoft 身份验证</a></li><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#创建一个新的-microsoft-身份认证客户端" class="sidebar-link">创建一个新的 Microsoft 身份认证客户端</a></li><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#登录测试" class="sidebar-link">登录测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#执行过程" class="sidebar-link">执行过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#登录过程" class="sidebar-link">登录过程</a></li><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#登出过程" class="sidebar-link">登出过程</a></li><li class="sidebar-sub-header"><a href="/docs/document/roadmap/dotnetcore/auth/is4/external-account.html#cookie-的作用" class="sidebar-link">Cookie 的作用</a></li></ul></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><a href="/docs/document/roadmap/java.html" class="sidebar-link">Java 学习之路</a></li><li><a href="/docs/document/roadmap/react.html" class="sidebar-link">React 学习之路</a></li><li><a href="/docs/document/roadmap/flutter.html" class="sidebar-link">Flutter 学习之路</a></li><li><a href="/docs/document/roadmap/android.html" class="sidebar-link">Android 学习之路</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JzGantt 组件使用文档</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="外部身份验证"><a href="#外部身份验证" class="header-anchor">#</a> 外部身份验证</h1> <p>基于 OAuth2 的特性，我们可以轻松通过外部账户进行登录。</p> <p>外部账户登录的好处：</p> <ul><li>方便用户操作。</li> <li>将管理登录流程的许多复杂性转移到了第三方。</li></ul> <h2 id="添加一个预定义的身份验证"><a href="#添加一个预定义的身份验证" class="header-anchor">#</a> 添加一个预定义的身份验证</h2> <p>IS4 在 ASP.NET Core 框架的基础上提供了更丰富和完整的预定义外部登录配置。</p> <h3 id="配置一个-microsoft-身份验证"><a href="#配置一个-microsoft-身份验证" class="header-anchor">#</a> 配置一个 Microsoft 身份验证</h3> <p>下面通过创建一个使用 Microsoft 身份进行验证的最小实例来介绍外部验证过程。</p> <div class="custom-block tip"><p class="custom-block-title">示例代码</p> <p>具体代码可以看 <a href="https://github.com/jeremyjone/dotnet-study-road/tree/master/AuthenticationAndAuthorization/AuthenticationAndAuthorization.ExternalAccount" target="_blank" rel="noopener noreferrer">示例代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <p>使用命令创建一个全新项目：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>dotnet new is4aspid --name ExternailAccount
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会得到一个完整使用 IS4 的项目，而且已经内置好了 Google 的外部认证。</p> <p>因为我们需要的是 Microsoft 的身份认证，所以需要添加包：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Microsoft.AspNetCore.Authentication.MicrosoftAccount（3.1.5）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>下载时需要注意版本。</p></div> <p>在 <code>Startup.cs</code> 配置中的认证服务后面追加如下内容：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddGoogle</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>SignInScheme <span class="token operator">=</span> IdentityServerConstants<span class="token punctuation">.</span>ExternalCookieAuthenticationScheme<span class="token punctuation">;</span>

        <span class="token comment">// register your IdentityServer with Google at https://console.developers.google.com</span>
        <span class="token comment">// enable the Google+ API</span>
        <span class="token comment">// set the redirect URI to https://localhost:5001/signin-google</span>
        options<span class="token punctuation">.</span>ClientId <span class="token operator">=</span> <span class="token string">&quot;copy client ID from Google here&quot;</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>ClientSecret <span class="token operator">=</span> <span class="token string">&quot;copy client secret from Google here&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 添加 Microsoft 认证</span>
    <span class="token punctuation">.</span><span class="token function">AddMicrosoftAccount</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft&quot;</span><span class="token punctuation">,</span> options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>SignInScheme <span class="token operator">=</span> IdentityServerConstants<span class="token punctuation">.</span>ExternalCookieAuthenticationScheme<span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>ClientId <span class="token operator">=</span> <span class="token string">&quot;microsoft_client_id&quot;</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>ClientSecret <span class="token operator">=</span> <span class="token string">&quot;microsoft_client_secret&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>运行项目，已经可以看到登录按钮。</p> <img src="/docs/assets/roadmap/dotnet/is4_external_ms.png" alt="is4_external_ms"> <p>如果你的 Id 和 Secret 配置正确，现在已经可以正常登录了。没错，就是这么简单的使用。但是如果没有配置相应的 Id 和 Secret，没关系，按照下面步骤操作即可。</p> <h3 id="创建一个新的-microsoft-身份认证客户端"><a href="#创建一个新的-microsoft-身份认证客户端" class="header-anchor">#</a> 创建一个新的 Microsoft 身份认证客户端</h3> <p>打开 <a href="https://go.microsoft.com/fwlink/?linkid=2083908" target="_blank" rel="noopener noreferrer">应用注册页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这是 Microsoft 的 Azure 门户，我们开发的客户端需要在这里注册。登录 Microsoft 账户后即可看到主页面。</p> <h4 id="注册客户端"><a href="#注册客户端" class="header-anchor">#</a> 注册客户端</h4> <ul><li>选择左上角的 <strong>新注册</strong>。</li></ul> <img src="/docs/assets/roadmap/dotnet/is4_external_ms_azurepage.png" alt="is4_external_ms_azurepage"> <ul><li>输入 “名称”。</li> <li>为 <strong>支持的账户类型</strong> 选择一个选项（如果不是组织，一定选择下面两项包含个人的）。</li> <li>在 <strong>重定向 URI</strong> 中输入开发的 URL 并追加 <code>/signin-microsoft</code>。</li></ul> <img src="/docs/assets/roadmap/dotnet/is4_external_ms_azure_register.png" alt="is4_external_ms_azure_register"> <ul><li>最后点击 <strong>注册</strong> 即可。</li></ul> <h4 id="添加秘钥"><a href="#添加秘钥" class="header-anchor">#</a> 添加秘钥</h4> <ul><li>选择左侧的 <strong>证书和密码</strong>。</li></ul> <img src="/docs/assets/roadmap/dotnet/is4_external_ms_azure_registed.png" alt="is4_external_ms_azure_registed"> <ul><li>在 <strong>客户端密码</strong> 下面选择 <strong>新的客户端密码</strong>。</li> <li>添加客户端密码的说明并选择有效期，然后点击 <strong>添加</strong>。</li> <li>复制 <strong>客户端秘钥</strong> 的 <strong>值</strong> 与 <strong>ID</strong>。（一定要复制 <strong>值</strong>，离开了页面再打开就不能查看和复制该值了）</li></ul> <img src="/docs/assets/roadmap/dotnet/is4_external_ms_azure_create_secret.png" alt="is4_external_ms_azure_create_secret"> <h3 id="登录测试"><a href="#登录测试" class="header-anchor">#</a> 登录测试</h3> <p>有了 ID 和秘钥，添加到我们的代码中，再次运行，已经可以登录该客户端了。</p> <img src="/docs/assets/roadmap/dotnet/is4_external_ms_azure_login.png" alt="is4_external_ms_azure_login"> <h2 id="执行过程"><a href="#执行过程" class="header-anchor">#</a> 执行过程</h2> <h3 id="登录过程"><a href="#登录过程" class="header-anchor">#</a> 登录过程</h3> <p>整个外部验证的流程是从点击登录按钮开始的。</p> <p>1、看 <code>Login.cshtml</code> 页面的代码，点击按钮后会定向到 <code>Login</code> URI，因为是配置的外部登录信息，所以会包含对应的 <code>scheme</code> 和 <code>returnUrl</code> 信息，这是页面写好的。</p> <p>2、当控制器收到请求之后，检查这是一个外部验证请求，于是跳转到 <code>Challenge</code> Action 中，
它会触发身份验证处理程序，通过 <code>HttpContext</code> 中的 <code>ChallengeAsync</code> 或者是 MVC 项目中的 <code>ChallengeResult</code> 来调用外部身份验证处理程序。</p> <p>3、回调接收，通过定义好的 <code>RedirectUri</code>，可以在完成验证之后调转到指定接收器。剩下的事情就是在回调方法中添加需要的内容即可。典型的任务如：</p> <ul><li>检查外部提供者返回的身份</li> <li>决定如何与该用户进行交互，新、老用户的区别等</li> <li>新用户如何才被允许</li> <li>是否需要创建本地账户并关联到外部账户</li> <li>存储需要保留的外部声明</li> <li>删除临时 Cookie</li> <li>登录用户</li></ul> <h3 id="登出过程"><a href="#登出过程" class="header-anchor">#</a> 登出过程</h3> <p>用户登出时，通常被重定向至外部程序进行登出，但是并不是所有外部程序都支持登出，这取决于它们的协议和特性。</p> <p>要检测用户必须重定向到外部标识提供者以进行登出，通常可以使用 IdentityServer 上发布到 Cookie 中的 idp 声明。声明中设置的值是对应的认证中间件的 AuthenticationScheme。在登出时，会咨询该声明以了解是否需要外部登出。</p> <p>由于正常的登出工作流已经需要清理和状态管理，将用户重定向到外部身份提供程序是有问题的。然后，在 IdentityServer 上完成正常的登出和清理过程的唯一方法是，在用户注销后，从外部标识提供者请求将用户重定向回 IdentityServer。</p> <p>登出后撤销 IdentityServer 的身份验证的 Cookie，然后重定向到请求注销后外部程序的重定向链接。登出后应该维护必要的登出状态，要在外部程序登出后重定向回 IdentityServer，当使用 SignOut 时，RedirectUri 应该在 AuthenticationProperties 中使用：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateAntiForgeryToken</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Logout</span><span class="token punctuation">(</span><span class="token class-name">LogoutInputModel</span> model<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>TriggerExternalSignout<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// build a return URL so the upstream provider will redirect back</span>
        <span class="token comment">// to us after the user has logged out. this allows us to then</span>
        <span class="token comment">// complete our single sign-out processing.</span>
        <span class="token class-name"><span class="token keyword">string</span></span> url <span class="token operator">=</span> Url<span class="token punctuation">.</span><span class="token function">Action</span><span class="token punctuation">(</span><span class="token string">&quot;Logout&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> logoutId <span class="token operator">=</span> vm<span class="token punctuation">.</span>LogoutId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// this triggers a redirect to the external provider for sign-out</span>
        <span class="token keyword">return</span> <span class="token function">SignOut</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthenticationProperties</span> <span class="token punctuation">{</span> RedirectUri <span class="token operator">=</span> url <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>ExternalAuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="cookie-的作用"><a href="#cookie-的作用" class="header-anchor">#</a> Cookie 的作用</h3> <p>在上面示例中，我们的 <code>SignInScheme</code> 是 Cookie 的方式：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>options<span class="token punctuation">.</span>SignInScheme <span class="token operator">=</span> IdentityServerConstants<span class="token punctuation">.</span>ExternalCookieAuthenticationScheme<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该 Cookie 将临时存储外部身份验证的结果，这是必要的，因为在过程完成之前，通常都会设计几个重定向。鉴于这是一种通常的做法，IS4 专门为一些外部程序注册了 Cookie 处理程序，通过上面代码的常量表示。</p> <p>但是也可以使用自定义的方式：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddCookie</span><span class="token punctuation">(</span><span class="token string">&quot;CustomCookieScheme&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddMicrosoftAccount</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft&quot;</span><span class="token punctuation">,</span> options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>SignInScheme <span class="token operator">=</span> <span class="token string">&quot;CustomCookieScheme&quot;</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>ClientId <span class="token operator">=</span> <span class="token string">&quot;microsoft_client_id&quot;</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>ClientSecret <span class="token operator">=</span> <span class="token string">&quot;microsoft_client_secret&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>对于特殊情况，还可以使外部 Cookie 机制短路，直接将外部用户转发到主 Cookie 处理程序，来确保外部标识源进行正确的声明转换。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jeremyjone/docs-admin/edit/master/docs/document/roadmap/dotnetcore/auth/is4/external-account.md" target="_blank" rel="noopener noreferrer">修改此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">3/26/2021, 2:19:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/document/roadmap/dotnetcore/auth/is4/useef.html" class="prev">
        数据的持久化（使用数据库）
      </a></span> <span class="next"><a href="/docs/document/roadmap/dotnetcore/log/Serilog.html">
        Serilog 的使用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.f8f5e4c5.js" defer></script><script src="/docs/assets/js/2.19a43536.js" defer></script><script src="/docs/assets/js/34.8585a287.js" defer></script>
  </body>
</html>
