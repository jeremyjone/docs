# 原理部分

## 浏览器的渲染机制和原理

当我们在浏览器地址栏中键入一个地址，然后按下回车，此时一个请求便开始了。

这个过程分成两个阶段：

- 请求阶段：负责从服务器获取内容
- 渲染阶段：负责将获取到的内容呈现在浏览器中

### 请求阶段

1、当客户端开输入一个网址后，会向服务器发送一个 [Request 请求](network.html#请求-request)，首先需要 `DNS` 解析，然后进行 `TCP` 连接。

2、服务器收到请求后，会发送一个 [Response 响应](./network.html#响应-response)给客户端，并将文件内容返回给客户端。

::: tip 说明
[实际请求](./network.html#http)要比上述过程更加繁琐，但并不影响对于渲染的理解。
:::

### 渲染阶段

1、客户端拿到页面内容后，浏览器会在内存中开辟一块**栈内存**，用来给代码的执行提供环境，同时分配一个主线程一行一行解析和执行代码。

> 因为 `JavaScript` 是单线程，所以每执行完一条语句，都需要执行出栈操作，然后将下一条语句执行进栈操作

2、当浏览器遇到 `link`、`script`、`img`、`video` 等资源请求，都会开辟一个全新的线程去加载资源文件，这个全新的线程叫 **任务队列（Task Queue）**。

3、当主文件（不包含资源文件）第一次自上而下加载完成后，会生成 `DOM-Tree`。

4、加载完 `DOM-Tree` 后，浏览器会去**任务队列**循环查看那些任务已经完成，然后将已完成的任务一个一个插入到 `DOM-Tree` 中，知道所有任务全部完成。这叫 **事件循环（Event Loop）**。

> 任务队列又分成 **微任务** 和 **宏任务**，**微任务** 的优先级高于 **宏任务**

5、当 CSS 处理完成后，会生成 `CSSOM`，浏览器会将 `DOM-Tree` 与 `CSSOM` 合并成一个 **渲染树（Render Tree）**。

6、回流。浏览器根据生成的 `Render Tree`，计算它们在设备视口内的确切位置和大小，这个计算阶段叫做 **回流（Reflow）**。

7、重绘。根据 `Render Tree` 以及 **回流** 得到的几何信息，得到节点的绝对像素，这个阶段叫做 **重绘（Repaint）**。

> 在首次加载阶段，一定会发生 **回流** 和 **重绘**，并且一定先 **回流** 再 **重绘**

8、最后，浏览器会调用 GPU 进行图形渲染，将 `Render Tree` 的内容渲染并展示给用户。

<img :src="$withBase('/assets/roadmap/frontend/render-process.png')" alt="">
